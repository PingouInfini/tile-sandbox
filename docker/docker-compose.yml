services:
  mbtileserver:
    image: ghcr.io/consbio/mbtileserver:latest
    container_name: mbtileserver
    ports:
      - "8899:8000"
    volumes:
      # On monte le dossier contenant le fichier .mbtiles dans le dossier /tiles du conteneur
      - /docker/appdata/tileserver/mbtiles:/tilesets:ro
    networks:
      - tileserver

  nginx-map-assets:
    image: nginx:latest
    container_name: nginx-map-assets
    ports:
      - "8898:80"
    volumes:
      - /docker/appdata/tileserver/fonts:/usr/share/nginx/html/fonts:ro
      - /docker/appdata/tileserver/pmtiles:/usr/share/nginx/html/pmtiles:ro
      - /docker/appdata/tileserver/examples:/usr/share/nginx/html/examples:ro
      - /docker/appdata/tileserver/nginx/nginx-map-assets.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - tileserver

  tileserver-gl:
    image: maptiler/tileserver-gl
    container_name: tileserver-gl
    ports:
      - "8897:8080"
    volumes:
      # On monte le dossier contenant le .mbtiles
      - /docker/appdata/tileserver/mbtiles:/data/mbtiles:ro
      - /docker/appdata/tileserver/tileserver-gl/config.json:/data/config.json:ro
      - /docker/appdata/tileserver/tileserver-gl/styles:/data/styles:ro
      - /docker/appdata/tileserver/fonts:/data/fonts:ro
    command: -c /data/config.json
    networks:
      - tileserver
      
  graphhopper:
    image: israelhikingmap/graphhopper:latest
    container_name: graphhopper
    ports:
      - "8896:8989"
    volumes:
      - /docker/appdata/tileserver/graphhopper/data:/data
    environment:
      - JAVA_OPTS=-Xmx4g -Xms2g
    command: >
      --input /data/france-latest.osm.pbf
      --graph-cache /data/graph-cache
    networks:
      - tileserver

  photon:
    image: rtuszik/photon-docker:latest
    container_name: photon
    ports:
      - "8895:2322"
    volumes:
      - /docker/appdata/tileserver/photon/data:/photon/data
    environment:
      - UPDATE_STRATEGY=DISABLED
      - REGION=france
      - MEMORY=4g
    networks:
      - tileserver

  # -------------------------------------------------------
  # OVERPASS API - Le moteur de base de donn√©es
  # -------------------------------------------------------
  overpass-api:
    image: wiktorn/overpass-api:latest
    container_name: overpass-api
    ports:
      - "8894:80"
    volumes:
      - /docker/appdata/tileserver/overpass/db:/db
      - /docker/appdata/tileserver/overpass/data/monaco-260206.osm.bz2:/monaco.osm.bz2:ro
    environment:
      - OVERPASS_MODE=init
      - OVERPASS_META=no
      - OVERPASS_PLANET_URL=file:///monaco.osm.bz2
      - OVERPASS_RULES_LOAD=10
      - OVERPASS_STOP_AFTER_INIT=false
    networks:
      - tileserver


 # -------------------------------------------------------
  # OVERPASS TURBO - L'interface Web
  # -------------------------------------------------------
  overpass-turbo-ui:
    image: nginx:alpine
    container_name: overpass-turbo-ui
    ports:
      - "8892:80"
    volumes:
      - /docker/appdata/tileserver/overpass-turbo/html/dist:/usr/share/nginx/html:ro
    networks:
      - tileserver

networks:
  tileserver:
    name: tileserver
    ipam:
      driver: default
      config:
        - subnet: 172.41.0.0/24
          ip_range: 172.41.0.0/24
          gateway: 172.41.0.1