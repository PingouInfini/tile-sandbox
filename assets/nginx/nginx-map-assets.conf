server {
    listen 80;
    server_name _;
    server_tokens off;

    # Méthodes autorisées
    if ($request_method !~ ^(GET|HEAD|OPTIONS)$ ) {
        return 405;
    }

    # Headers de sécurité globaux
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Resource-Policy "cross-origin" always;

    # Désactive l'indexation par défaut
    autoindex off;

    # =========================
    # Fonts
    # =========================
    location /fonts/ {
        root /usr/share/nginx/html;
        try_files $uri =404;
        sendfile off;

        types {
            application/x-protobuf pbf;
        }

        # CORS pour MapLibre
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept" always;

        # Cache long (les fonts changent rarement)
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # =========================
    # PMTiles
    # =========================
    location /pmtiles/ {
        root /usr/share/nginx/html;
        try_files $uri =404;
        sendfile off;

        add_header Accept-Ranges bytes always;

        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept" always;

        # Cache long aussi
        expires 7d;
        add_header Cache-Control "public";
    }

    # =========================
    # Examples (HTML/JS/CSS)
    # =========================
    location /examples/ {
        root /usr/share/nginx/html;
        autoindex on;
        try_files $uri $uri/ =404;

        # Cache différent selon type
        location ~* \.(html)$ {
            expires -1;
            add_header Cache-Control "no-cache";
        }

        location ~* \.(js|css)$ {
            expires 7d;
            add_header Cache-Control "public";
        }

        location ~* \.(png|jpg|jpeg|gif|svg|webp)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }

    # =========================
    # Proxy Photon (Géocodage)
    # =========================
    location /photon/ {
        # On utilise le nom du conteneur défini dans docker-compose
        # Le port interne de Photon dans le conteneur est 2322
        proxy_pass http://photon:2322/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # On force les headers CORS pour autoriser les appels JS
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept" always;
    }

    # =========================
    # Proxy GraphHopper (Itinéraire)
    # =========================
    location /gh/ {
        # Le port interne de GraphHopper est 8989
        proxy_pass http://graphhopper:8989/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Headers CORS
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept" always;
    }

    # =========================
    # Refus d'accès aux fichiers sensibles
    # =========================
    location ~ /\.(?!well-known) {
        deny all;
    }
}
